---
import Layout from '../layouts/Layout.astro';
import publicationsData from '../data/publications.json';

// Sort by year, most recent first
const publications = publicationsData.sort((a, b) => b.year - a.year);

// Helper function to format all authors
function formatAuthors(authors: string[]): string {
  if (authors.length === 0) return '';
  if (authors.length === 1) return authors[0];
  if (authors.length === 2) return `${authors[0]} and ${authors[1]}`;

  // Join all authors with commas, and "and" before the last one
  const lastAuthor = authors[authors.length - 1];
  const otherAuthors = authors.slice(0, -1).join(', ');
  return `${otherAuthors}, and ${lastAuthor}`;
}

// Group publications by year
const publicationsByYear = publications.reduce((acc, pub) => {
  if (!acc[pub.year]) {
    acc[pub.year] = [];
  }
  acc[pub.year].push(pub);
  return acc;
}, {} as Record<number, typeof publications>);

const years = Object.keys(publicationsByYear).sort((a, b) => Number(b) - Number(a));
---

<Layout title="Publications - Francesc CatalÃ -Moll">
  <article class="py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-5xl mx-auto">

      <!-- Back Button -->
      <a
        href="/"
        class="inline-flex items-center gap-2 text-primary hover:text-primary-dark mb-8 transition-colors duration-200"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        Back to home
      </a>

      <!-- Page Header -->
      <header class="mb-12">
        <h1 class="text-3xl sm:text-4xl lg:text-5xl font-serif font-bold text-slate-900 mb-4">
          Publications
        </h1>
        <p class="text-lg text-slate-600 font-sans">
          Peer-reviewed research in epigenetics, microbiome, and immunology
        </p>
        <p class="text-sm text-slate-500 font-sans mt-2">
          {publications.length} publications
        </p>

        <!-- Featured publications legend -->
        <div class="mt-6 flex items-center justify-end gap-2 text-sm text-slate-600">
          <img
            src="/1-2962cfe1.ico"
            alt="Featured"
            class="w-5 h-5 object-contain"
          />
          <span>Featured publications</span>
        </div>
      </header>

      <!-- Publications by Year -->
      <div class="space-y-12">
        {years.map((year) => (
          <section>
            <!-- Year Header -->
            <div class="mb-6 pb-2 border-b-2 border-primary/20">
              <h2 class="text-2xl font-serif font-bold text-slate-900">
                {year}
              </h2>
              <p class="text-sm text-slate-500 mt-1">
                {publicationsByYear[Number(year)].length} {publicationsByYear[Number(year)].length === 1 ? 'publication' : 'publications'}
              </p>
            </div>

            <!-- Publications Grid -->
            <div class="space-y-6">
              {publicationsByYear[Number(year)].map((pub) => (
                <a
                  href={pub.link || `https://doi.org/${pub.doi}`}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="group block"
                >
                  <article class="relative pl-6 pr-4 py-5 border-l-4 border-slate-200 group-hover:border-primary transition-all duration-300 bg-white group-hover:bg-slate-50/50">
                    <!-- Featured Badge -->
                    {pub.featured && (
                      <div class="absolute top-4 right-4">
                        <img
                          src="/1-2962cfe1.ico"
                          alt="Featured publication"
                          class="w-12 h-12 object-contain"
                        />
                      </div>
                    )}

                    <!-- Title -->
                    <h3 class="text-lg font-serif font-bold text-slate-900 group-hover:text-primary transition-colors duration-200 mb-3 pr-20">
                      {pub.title}
                      <svg class="inline-block w-4 h-4 ml-2 text-slate-400 group-hover:text-primary transition-colors duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                      </svg>
                    </h3>

                    <!-- Authors -->
                    <p class="text-sm text-slate-600 mb-3 leading-relaxed">
                      {formatAuthors(pub.authors)}
                    </p>

                    <!-- Journal & Meta -->
                    <div class="flex flex-wrap items-baseline gap-x-3 gap-y-1 text-sm">
                      <span class="font-semibold text-primary-dark italic">
                        {pub.journal}
                      </span>
                      {(pub.volume || pub.number || pub.pages) && (
                        <span class="text-slate-500">
                          {pub.volume && `${pub.volume}`}
                          {pub.number && `(${pub.number})`}
                          {pub.pages && `: ${pub.pages}`}
                        </span>
                      )}
                    </div>

                    <!-- DOI -->
                    {pub.doi && (
                      <p class="text-xs text-slate-400 mt-2 font-mono group-hover:text-slate-500 transition-colors duration-200">
                        {pub.doi}
                      </p>
                    )}
                  </article>
                </a>
              ))}
            </div>
          </section>
        ))}
      </div>

      <!-- Footer Navigation -->
      <footer class="mt-16 pt-8 border-t border-slate-200">
        <a
          href="/"
          class="inline-flex items-center gap-2 text-slate-600 hover:text-primary transition-colors duration-200"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
          Back to home
        </a>
      </footer>
    </div>
  </article>
</Layout>
