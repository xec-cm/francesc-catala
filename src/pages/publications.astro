---
import Layout from '../layouts/Layout.astro';
import publicationsData from '../data/publications.json';

// Sort by year, most recent first
const publications = publicationsData.sort((a, b) => b.year - a.year);

// Helper function to format authors list
function formatAuthors(authors: string[]): string {
  if (authors.length === 0) return '';
  if (authors.length === 1) return authors[0];
  if (authors.length === 2) return `${authors[0]} and ${authors[1]}`;

  // Find if Català-Moll is in the authors
  const catalaMollIndex = authors.findIndex(author =>
    author.includes('Català-Moll') || author.includes('Catala-Moll') || author.includes('F. Català-Moll')
  );

  if (catalaMollIndex === 0) {
    return `${authors[0]} et al.`;
  } else if (catalaMollIndex > 0) {
    return `${authors[0]}, ..., ${authors[catalaMollIndex]}, et al.`;
  }

  return `${authors[0]} et al.`;
}

// Group publications by year
const publicationsByYear = publications.reduce((acc, pub) => {
  if (!acc[pub.year]) {
    acc[pub.year] = [];
  }
  acc[pub.year].push(pub);
  return acc;
}, {} as Record<number, typeof publications>);

const years = Object.keys(publicationsByYear).sort((a, b) => Number(b) - Number(a));
---

<Layout title="Publications - Francesc Català-Moll">
  <article class="py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-5xl mx-auto">

      <!-- Back Button -->
      <a
        href="/"
        class="inline-flex items-center gap-2 text-primary hover:text-primary-dark mb-8 transition-colors duration-200"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        Back to home
      </a>

      <!-- Page Header -->
      <header class="mb-12">
        <h1 class="text-3xl sm:text-4xl lg:text-5xl font-serif font-bold text-slate-900 mb-4">
          Publications
        </h1>
        <p class="text-lg text-slate-600 font-sans">
          Peer-reviewed research in epigenetics, microbiome, and immunology
        </p>
        <p class="text-sm text-slate-500 font-sans mt-2">
          {publications.length} publications
        </p>
      </header>

      <!-- Publications by Year -->
      <div class="space-y-12">
        {years.map((year) => (
          <section>
            <!-- Year Header -->
            <div class="mb-6 pb-2 border-b-2 border-primary/20">
              <h2 class="text-2xl font-serif font-bold text-slate-900">
                {year}
              </h2>
              <p class="text-sm text-slate-500 mt-1">
                {publicationsByYear[Number(year)].length} {publicationsByYear[Number(year)].length === 1 ? 'publication' : 'publications'}
              </p>
            </div>

            <!-- Publications Grid -->
            <div class="grid gap-6">
              {publicationsByYear[Number(year)].map((pub) => (
                <a
                  href={pub.link || `https://doi.org/${pub.doi}`}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="group"
                >
                  <article class="bg-slate-50 rounded-lg p-6 transition-all duration-300 hover:shadow-lg hover:bg-white hover:-translate-y-0.5 border border-slate-200 hover:border-primary">
                    <div class="flex items-start justify-between gap-4 mb-3">
                      <h3 class="text-lg font-serif font-bold text-slate-900 group-hover:text-primary transition-colors duration-200 flex-1">
                        {pub.title}
                      </h3>
                      <svg class="w-5 h-5 text-slate-400 group-hover:text-primary transition-colors duration-200 flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                      </svg>
                    </div>

                    <!-- Authors -->
                    <p class="text-sm text-slate-600 mb-3">
                      {formatAuthors(pub.authors)}
                    </p>

                    <!-- Journal & Details -->
                    <div class="flex flex-wrap items-center gap-3 text-sm">
                      <p class="font-medium text-primary-dark italic">
                        {pub.journal}
                      </p>
                      {pub.volume && (
                        <span class="text-slate-500">
                          Vol. {pub.volume}
                        </span>
                      )}
                      {pub.number && (
                        <span class="text-slate-500">
                          No. {pub.number}
                        </span>
                      )}
                      {pub.pages && (
                        <span class="text-slate-500">
                          pp. {pub.pages}
                        </span>
                      )}
                    </div>

                    <!-- DOI -->
                    {pub.doi && (
                      <p class="text-xs text-slate-500 mt-3 font-mono">
                        DOI: {pub.doi}
                      </p>
                    )}
                  </article>
                </a>
              ))}
            </div>
          </section>
        ))}
      </div>

      <!-- Footer Navigation -->
      <footer class="mt-16 pt-8 border-t border-slate-200">
        <a
          href="/"
          class="inline-flex items-center gap-2 text-slate-600 hover:text-primary transition-colors duration-200"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
          Back to home
        </a>
      </footer>
    </div>
  </article>
</Layout>
